  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    const el = (id) => document.getElementById(id);

    function addMessage(role, text) {
      const wrap = document.createElement("div");
      wrap.className = "msg " + (role === "user" ? "user" : "bot");
      wrap.textContent = text;
      el("chatMessages").appendChild(wrap);
      el("chatMessages").scrollTop = el("chatMessages").scrollHeight;
      state.transcript.push({ role, content: text });
    }

    function openChat() {
      el("chat").setAttribute("aria-hidden", "false");
      el("chat").classList.add("open");
      el("chatText").focus();
    }

    function closeChat() {
      el("chat").classList.remove("open");
      el("chat").setAttribute("aria-hidden", "true");
    }

    function looksLikeEmail(t) {
      return /[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i.test(t);
    }

    function looksLikePhone(t) {
      const digits = (t || "").replace(/\D/g, "");
      return digits.length >= 10 && digits.length <= 15;
    }

    function extractEmail(t) {
      const m = (t || "").match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
      return m ? m[0] : "";
    }

    function extractPhone(t) {
      const digits = (t || "").replace(/\D/g, "");
      return digits.length >= 10 ? digits : "";
    }

    function normalizeList(t) {
      return (t || "")
        .split(/,|\n|;|\|/g)
        .map((s) => s.trim())
        .filter(Boolean);
    }

    // -----------------------------
    // Lead state
    // -----------------------------
    const state = {
      step: 0,
      description: "",
      name: "",
      email: "",
      phone: "",
      location: "Hampton, SC",
      businessType: "",
      pages: [],
      features: [],
      timeline: "",
      budget: "",
      maintenance: null,
      notes: "",
      leadSent: false,
      transcript: [],
    };

    // prevent duplicate emails across refresh for the same visitor (optional)
    const sentKey = "cfd_lead_sent_v1";
    if (localStorage.getItem(sentKey) === "1") state.leadSent = true;

    async function sendLeadIfReady() {
      if (state.leadSent) return;

      // ✅ Only send when these 3 are ready:
      if (!state.description) return;
      if (!state.businessType) return;
      if (!state.email) return;

      const payload = {
        description: state.description,
        businessType: state.businessType,
        email: state.email,

        // optional extras
        name: state.name,
        phone: state.phone,
        location: state.location,
        pages: state.pages,
        features: state.features,
        timeline: state.timeline,
        budget: state.budget,
        maintenance: state.maintenance,
        notes: state.notes,
        transcript: state.transcript,
      };

      try {
        const r = await fetch("/api/leads", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await r.json();

        if (data.ok) {
          state.leadSent = true;
          localStorage.setItem(sentKey, "1");
          addMessage(
            "assistant",
            "Perfect — got it. I just emailed your details to our team. ✅"
          );
          return;
        }

        addMessage(
          "assistant",
          "I had trouble submitting that. You can also email us directly at contactcrownforgedigital@gmail.com."
        );
      } catch (e) {
        addMessage(
          "assistant",
          "I had trouble submitting that. You can also email us directly at contactcrownforgedigital@gmail.com."
        );
      }
    }

    function nextQuestion() {
      // Stop looping once sent
      if (state.leadSent) return;

      // Required send fields (minimal)
      if (!state.description) {
        addMessage(
          "assistant",
          "Quickly describe what you need (example: “I need a 3-page site with a quote form and gallery”)."
        );
        return;
      }
      if (!state.businessType) {
        addMessage(
          "assistant",
          "What type of business is this? (Example: HVAC, lawn care, barber, restaurant)"
        );
        return;
      }
      if (!state.email) {
        addMessage(
          "assistant",
          "What email should we send your quote summary to?"
        );
        return;
      }

      // All required fields collected → send
      sendLeadIfReady();
    }

    function handleUserText(text) {
      const t = (text || "").trim();
      if (!t) return;

      addMessage("user", t);

      // Capture email/phone if present anywhere
      if (!state.email && looksLikeEmail(t)) state.email = extractEmail(t);
      if (!state.phone && looksLikePhone(t)) state.phone = extractPhone(t);

      // Capture description first (ignore messages that are just contact info)
      if (!state.description && !looksLikeEmail(t) && !looksLikePhone(t)) {
        state.description = t;
        addMessage("assistant", "Got it.");
        return nextQuestion();
      }

      // Capture business type (short answer)
      if (
        !state.businessType &&
        t.length <= 60 &&
        !looksLikeEmail(t) &&
        !looksLikePhone(t)
      ) {
        state.businessType = t;
        addMessage("assistant", `Got it — ${state.businessType}.`);
        return nextQuestion();
      }

      // Optional extras (won't block sending)
      if (
        state.pages.length === 0 &&
        /(home|services|contact|about|gallery|portfolio|menu|pricing|reviews)/i.test(t)
      ) {
        state.pages = normalizeList(t);
      }
      if (state.features.length === 0) {
        // accept ANY answer for features, including "none"
        if (
          /(quote|booking|appointment|calendar|payment|stripe|square|gallery|reviews|forms?|none|no features|nope|no)/i.test(
            t
          )
        ) {
          state.features = normalizeList(t);
          if (state.features.length === 0) state.features = ["None"];
        }
      }
      if (!state.timeline && /(asap|week|weeks|month|days)/i.test(t)) {
        state.timeline = t;
      }

      // Store anything else as notes (keeps context)
      if (!looksLikeEmail(t) && !looksLikePhone(t)) {
        state.notes = (state.notes ? state.notes + " " : "") + t;
      }

      // If we got an email, try to send once the required fields exist
      if (state.email && !state.leadSent) {
        return nextQuestion();
      }

      nextQuestion();
    }

    function handleIntent(intent) {
      switch (intent) {
        case "pricing":
          addMessage(
            "assistant",
            "Bundles: Starter (1–3 pages), Growth (5–7 pages), plus CrownCare maintenance ($25–$35/mo). Want Starter or Growth?"
          );
          break;
        case "timeline":
          addMessage(
            "assistant",
            "Typical timelines: Starter 3–7 days, Growth 7–14 days depending on content. What timeline do you need?"
          );
          break;
        case "booking":
          addMessage(
            "assistant",
            "We can add booking/appointments (Calendly or custom). What business type is this and do you need payments too?"
          );
          break;
        case "quote":
          addMessage(
            "assistant",
            "To quote you fast, tell me: what you need (description), your business type, and your email."
          );
          break;
        default:
          addMessage("assistant", "Tell me what you need and I’ll guide you.");
      }
    }

    // -----------------------------
    // Wire UI
    // -----------------------------
    el("chatLaunch").addEventListener("click", () => {
      openChat();
      if (state.transcript.length === 0) {
        addMessage(
          "assistant",
          "Hey! I’m the CrownForge Concierge. Tell me what you need, and I’ll email you a quick summary."
        );
        nextQuestion();
      }
    });

    el("openChatTop").addEventListener("click", () => {
      el("chatLaunch").click();
    });
    el("openChatHero").addEventListener("click", () => {
      el("chatLaunch").click();
    });
    el("openChatBottom").addEventListener("click", () => {
      el("chatLaunch").click();
    });

    el("chatClose").addEventListener("click", closeChat);

    el("chatSend").addEventListener("click", () => {
      const v = el("chatText").value;
      el("chatText").value = "";
      handleUserText(v);
    });

    el("chatText").addEventListener("keydown", (e) => {
      if (e.key === "Enter") el("chatSend").click();
    });

    document.querySelectorAll(".chip").forEach((btn) => {
      btn.addEventListener("click", () => handleIntent(btn.dataset.intent));
    });
  </script>